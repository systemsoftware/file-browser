<!DOCTYPE html>
<html>
    <!DOCTYPE html>
    <html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="./SwipeDetector.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: system-ui, -apple-system, sans-serif;
            }
    
            body {
                min-height: 100vh;
                background: #f1f5f9;
            }
            *{
                scrollbar-width: none !important;
            }
    
            .container {
                display: flex;
                min-height: 100vh;
            }
    
            .sidebar {
                background: #1e293b;
                color: white;
                width: 15%; 
                padding: 16px; 
                transition: all 0.3s ease;
                height: 100vh;
                overflow-y: auto;
                position: fixed;
                left: 0;
                top: 0;
            }
    
            .sidebar-header {
                display: flex;
                align-items: center;
                margin-bottom: 24px;
                height: 40px;
            }
    
            .logo {
                font-size: large;
                font-weight: bold;
                white-space: nowrap;
                overflow: hidden;
                text-align: center;
                width: 100%;
                margin-top: 5vh;
            }
    
            .toggle-btn {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                padding: 8px;  /* Reduced from 10px */
                margin-left: auto;
            }
    
            .nav-section {
                margin-bottom: 20px;  /* Reduced from 24px */
            }
    
            .section-title {
                font-size: 11px;  /* Reduced from 12px */
                text-transform: uppercase;
                color: #64748b;
                margin-bottom: 6px;
                padding: 0 12px;  /* Reduced from 15px */
            }
    
            .nav-item {
                display: flex;
                align-items: center;
                padding: 10px 12px;  /* Reduced from 12px 15px */
                margin: 3px 0;  /* Reduced from 4px */
                border-radius: 6px;  /* Reduced from 8px */
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }
    
            .nav-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }
    
            .nav-item i {
                min-width: 22px;  /* Reduced from 24px */
                font-size: 16px;  /* Reduced from 18px */
                text-align: center;
                margin-right: 10px;  /* Reduced from 12px */
            }
    
            .nav-item span {
                white-space: nowrap;
                overflow: hidden;
                font-size: 14px;  /* Added explicit font size */
            }
    
            .nav-item .submenu-toggle {
                margin-left: auto;
                transition: transform 0.3s ease;
            }
    
            .nav-item.active .submenu-toggle {
                transform: rotate(180deg);
            }
    
            .submenu {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                margin-left: 32px;  /* Reduced from 36px */
            }
    
            .submenu.active {
                max-height: 500px;
            }
    
            .submenu .nav-item {
                padding: 8px 12px;
                font-size: 13px;  /* Reduced from 14px */
            }
    
            .main-content {
                flex: 1;
                padding: 30px;
                margin-left:15%;
                transition: all 0.3s ease;
                min-height: 100vh;
            }
   
            .content-header {
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                margin-bottom: 30px;
            }
    
            .content-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
    
            .card {
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
    
            .card h3 {
                color: #1e293b;
                margin-bottom: 10px;
                font-size: 16px;
            }
    
            .card p {
                font-size: 24px;
                font-weight: bold;
                color: #0f172a;
            }
    
            .mobile-header {
                display: none;
                padding: 16px;  /* Reduced from 20px */
                background: white;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 98;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
    
            @media (max-width: 1024px) {
                .sidebar {
                    transform: translateX(-100%);
                    z-index: 100;
                }
    
                .sidebar.active {
                    transform: translateX(0);
                    width: 60%;
                }
    
                .main-content {
                    margin-left: 0;
                    padding-top: 80px;  /* Reduced from 90px */
                }
    
                .mobile-header {
                    display: flex;
                    align-items: center;
                }
    
                .mobile-header .toggle-btn {
                    color: #1e293b;
                    padding: 8px;
                }
    
                .mobile-header .logo {
                    color: #1e293b;
                    font-size: 18px;  /* Reduced from 20px */
                }
    
                .overlay {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 99;
                }
    
                .overlay.active {
                    display: block;
                }
            }
    
            @media (max-width: 640px) {
                .content-grid {
                    grid-template-columns: 1fr;
                }
    
                .main-content {
                    padding: 70px 15px 15px 15px;  /* Reduced top padding */
                }
            }
    
            @media (min-width: 1025px) {
                .sidebar .toggle-btn {
                    display: none;
                }
            }

            .home{
                margin-top: 5vh;
            }

            .folder-container {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    padding: 20px;
}
.folder-container {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    padding: 20px;
    background: #1e1e1e;
}

body{
    background: #1e1e1e;
}

.folder {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.08);
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    width: 280px !important;
    position: relative;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.folder:hover {
    background: rgba(255, 255, 255, 0.12);
}

.folder:active {
    background: rgba(255, 255, 255, 0.06);
}

/* Selected state */
.folder.selected {
    background: rgba(59, 121, 255, 0.3);
}

.folder-icon {
    width: 28px;
    height: 28px;
    margin-right: 12px;
}

.folder-name {
    color: #ffffff;
    font-size: 13px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 400;
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chevron {
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
    margin-left: 8px;
}

.folder:hover .chevron {
    color: rgba(255, 255, 255, 0.7);
}

/* Custom scrollbar styling */
.folder::-webkit-scrollbar {
    height: 3px;
}

.folder::-webkit-scrollbar-track {
    background: transparent;
}

.folder::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 1.5px;
}

.folder::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}


        #file-list {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            font-family: Arial, sans-serif;
        }

        /* put #location on top of content */
        #location {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #1e293b;
            color: white;
            padding: 10px 20px;
            font-family: Arial, sans-serif;
            z-index: 1000000 !important;
            width: 100%;
            text-align: center;
        }

        #location * {
            font-size: x-small;
            z-index: 1000000 !important;
        }

        #bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1e293b;
            color: white;
            padding: 10px 20px;
            font-family: Arial, sans-serif;
            z-index: 100;
            width: 100%;
            text-align: center;
        }

        #bottom * {
            font-size: x-small;
        }

        #action{
            margin-left: 10px;
            position: fixed !important;
            top: 1vh;
            right: 1.5vh;
        }

        #action *{
            font-size: large;
            margin-left: 1.2vh;
        }

        * {
            user-select: none;
        }

        body.dragover {
  cursor: copy;
}

        </style>
         <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
<body>
    <div class="container">
        <div class="overlay"></div>
        <div class="mobile-header">
            <button class="toggle-btn">
                <i class="material-icons">menu</i>
            </button>
            <div class="logo">Files</div>
        </div>
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="nav-item logo home" onclick="window.electron.goTo('recents')">
                    <i class="material-icons">history</i>
                    <span>Recents</span>
                </div>
                <button class="toggle-btn">
                    <i class="material-icons">close</i>
                </button>
            </div>

            <div id="location">
               <p id="path">Recents</p>
               <div id="action">
                <i class="material-icons" style="cursor: pointer;float: right;" onclick="window.electron.settings()">settings</i>
               <i class="material-icons" style="cursor: pointer;float: right;" id="search" onclick="filter()">search</i>
               <i class="material-icons" style="cursor: pointer;float: right;" onclick="window.electron.goBack(document.getElementById('path').innerHTML.split('|')[0])">arrow_back</i>
            </div>
            </div>
            <nav>
                <div class="nav-section" id="workspaces">
                    <div class="section-title">Workspaces</div>
                </div>

                <div class="nav-section" id="all">
                    <div class="section-title">Shortcuts</div>

                </div>

                <div class="nav-section" id="external">
                    <div class="section-title">Remote</div>
                </div>
        </aside>

        <main class="main-content" style="margin-top: 15px;">
            <div class="folder-container">
            </div>
        
        </main>
    </div>

    <script>
        const toggleBtns = document.querySelectorAll('.toggle-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.overlay');
        let workspace = '';
    
        const homedir = window.electron.homedir()
        
        function initializeSidebar() {
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile) {
                toggleBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        sidebar.classList.toggle('active');
                        overlay.classList.toggle('active');
                    });
                });
    
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
        }
    
        initializeSidebar();
        window.addEventListener('resize', () => {
            initializeSidebar();
        });
    
        const createNav = (name, icon, click, type) => {
            console.log(name, icon, type);
            const nav = document.createElement('div');
            nav.classList.add('nav-item');
            nav.innerHTML = `
            <i class="material-icons">${icon}</i>
            <span>${name}</span>
            `;
            nav.onclick = click;
            nav.oncontextmenu = (ev) => {
                window.electron.navContextMenu(ev.x, ev.y, name, type);
            }
            return nav;
        }
    
const workspaces = document.getElementById('workspaces');
window.electron.getWorkspaces().then(_workspaces => {
    console.log(_workspaces);
    _workspaces.forEach(ws => { // Renamed parameter to `ws`
        const workspaceItem = createNav(ws.name, ws.icon, () => {
            window.electron.goTo(ws.path);
            workspace = ws.path; // Now refers to the global `workspace` variable
        }, 'workspace');
        workspaces.appendChild(workspaceItem);
    });
});

        const all = document.getElementById('all');
        window.electron.getAllLocations().then(_all => {
            _all.forEach(file => {
                const fileItem = createNav(file.name, file.icon, () => {
                    window.electron.goTo(file.path)
                }, 'location');
                all.appendChild(fileItem);
            });
        });
    
        const external = document.getElementById('external');
        window.electron.getExternalLocations().then(_external => {
            _external.forEach(file => {
                const fileItem = createNav(file.name, file.icon, () => {
                    window.electron.goTo(file.path)
                }, 'external');
                external.appendChild(fileItem);
            });
        });
    
        window.electron.getSetting('sidebarWidth').then(width => {
            sidebar.style.width = width;
            document.querySelector('.main-content').style.marginLeft = width;
            console.log(width);
        });

        window.electron.getSetting('sidebarColor').then(color => {
    // Set the sidebar background color
    sidebar.style.background = color;
    document.getElementById('location').style.background = color;

    // Calculate appropriate text color (light or dark)
    const textColor = getContrastColor(color);

    // Apply the text color to all elements inside the sidebar
    const sidebarElements = document.querySelectorAll('.sidebar *');
    sidebarElements.forEach(element => {
        element.style.color = textColor;
    });
});

// Function to calculate contrast color
function getContrastColor(hexColor) {
    // Convert hex color to RGB
    const rgb = hexToRgb(hexColor);
    if (!rgb) return '#000'; // Default to black if conversion fails

    // Calculate luminance
    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;

    // Return black for light backgrounds, white for dark backgrounds
    return luminance > 0.5 ? '#000' : '#fff';
}

// Helper function to convert hex to RGB
function hexToRgb(hex) {
    // Expand shorthand hex (e.g., #03F) to full form (#0033FF)
    const fullHex = hex.replace(
        /^#?([a-f\d])([a-f\d])([a-f\d])$/i,
        (_, r, g, b) => `#${r}${r}${g}${g}${b}${b}`
    );

    // Extract RGB values
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16),
    } : null;
}
    
        const addWorkspace = createNav('New', 'add', () => {
            window.electron.addWorkspace().then(workspace => {
                if (!workspace) return;
                const workspaceItem = createNav(workspace.name, workspace.icon, () => {
                    window.electron.goTo(workspace.path)
                }, 'workspace');
                workspaces.appendChild(workspaceItem);
            });
        }, 'workspace');
        workspaces.appendChild(addWorkspace);
    
        const addLocation = createNav('Add', 'add', () => {
            window.electron.addLocation().then(location => {
                if (!location) return;
                const locationItem = createNav(location.name, location.icon, () => {
                    window.electron.goTo(location.path)
                }, 'location');
                all.appendChild(locationItem);
            });
        }, 'location');
        all.appendChild(addLocation);
    
        window.electron.handleUpdatedWorkspaces(w => {
            workspaces.innerHTML = '<div class="section-title">Workspaces</div> <div class="nav-item" onclick="window.electron.addWorkspace()"> <i class="material-icons">add</i> <span>New</span> </div>';
            w.forEach(workspace => {
                const workspaceItem = createNav(workspace.name, workspace.icon, () => {
                   window.electron.goTo(workspace.path)
                   workspace = workspace.path;
                }, 'workspace');
                workspaces.appendChild(workspaceItem);
            });
        });

        window.electron.handleUpdatedLocations(w => {
            all.innerHTML = '<div class="section-title">Shortcuts</div> <div class="nav-item" onclick="window.electron.addLocation()"> <i class="material-icons">add</i> <span>Add</span> </div>';
            w.forEach(workspace => {
                const item = createNav(workspace.name, workspace.icon, () => {
                    window.electron.goTo(workspace.path)
                }, 'workspace');
                all.appendChild(item);
            });
        });
    
        const createDir = (name, color, path) => {
            if(!color) color = '#64748b';
            const folder = document.createElement('div');
            folder.classList.add('folder');
            folder.innerHTML = `
            <i class="material-icons folder-icon" style="color: ${color}">folder</i>
            <span class="folder-name">${name}</span>
            <span class="chevron">â€º</span>
            `;
            folder.onclick = () => {
                window.electron.goTo(path)
            }
            folder.oncontextmenu = (ev) => {
                window.electron.dirContextMenu(ev.x, ev.y, name, path);
            }
            document.querySelector('.folder-container').appendChild(folder);
        }
    
        const createFile = (name, color, path) => {
    const folder = document.createElement('div');
    folder.classList.add('folder', color);
    folder.innerHTML = `
        <i class="material-icons folder-icon" style="color: ${color}">insert_drive_file</i>
        <span class="folder-name">${name}</span>
    `;
    folder.draggable = true;

    folder.oncontextmenu = (ev) => {
        window.electron.fileContextMenu(ev.x, ev.y, name, path);
    }

    folder.ondblclick = () => {
        window.electron.openFile(path);
    }

    folder.addEventListener('click', () => {
        window.electron.openFile(path);
    });
    

    // Track drag state
    let isDragging = false;

    folder.addEventListener('dragstart', (event) => {
        isDragging = true;
        window.electron.startDrag(path);
        event.target.blur();
    });

    folder.addEventListener('dragend', () => {
        isDragging = false;
        console.log('Drag operation ended');
        
        document.querySelectorAll('.folder').forEach(f => {
            f.style.pointerEvents = 'auto';
        });
        
        const evt = new MouseEvent('mousemove', {
            bubbles: true,
            cancelable: true,
            view: window,
            clientX: event.clientX,
            clientY: event.clientY
        });
        document.dispatchEvent(evt);
    });

    window.electron.onDragComplete((success) => {
        if (success && isDragging) {
            isDragging = false;
            document.querySelectorAll('.folder').forEach(f => {
                f.style.pointerEvents = 'auto';
            });
        }
    });

    document.querySelector('.folder-container').appendChild(folder);
};


window.electron.handleNewFileInWorkspace((file) => {
if (file.location !== document.getElementById('path').innerHTML.split(' | ')[0]) return;
file.type == 'file' ? createFile(file.name, file.color || '#64748b', file.path) : createDir(file.name, file.color || '#64748b', file.path);
});
    
    
        window.electron.getRecents().then(files => {
            files.forEach(file => {
                file.type === 'dir' ? createDir(file.name, file.color || '#64748b', file.path) : createFile(file.name, file.color || '#64748b', file.path);
            });
            document.getElementById('path').innerHTML = 'Recents | ' + files.length;
        });
    
        window.electron.handleViewChange(view => {
            document.querySelector('.folder-container').innerHTML = '';
            view = JSON.parse(view);
            console.log(view);
            view.data.forEach(file => {
                file.type === 'dir' ? createDir(file.name, file.color, file.path) : createFile(file.name, file.color, file.path);
            })
            document.getElementById('path').innerHTML = `${view.path.replace(homedir, '~')} | ${view.data.length} ${view.size ? `| ${view.size}` : ''}`;
        });
    
        document.getElementById('path').addEventListener('dblclick', () => {
            window.electron.goTo(document.getElementById('path').innerHTML.split(' | ')[0], true);
        });
    
        const swipeDetector = new SwipeDetector(document.querySelector('.main-content'), {
            threshold: 50,
            restraint: 100, 
            allowedTime: 300, 
            onLeftSwipe: () => {
                window.electron.goTo('..', false,document.getElementById('path').innerHTML.split('|')[0]);
            }
        });
    
        const filter = async () => {
            const term = await window.electron.prompt('File Search', 'Enter the file name to search');
            if (!term) {
                const folders = document.querySelectorAll('.folder');
                folders.forEach(folder => {
                    folder.style.display = 'flex';
                });
                document.getElementById('sterm').remove()
                return;
            }
            const folders = document.querySelectorAll('.folder');
            folders.forEach(folder => {
                if (folder.querySelector('.folder-name').innerHTML.toLowerCase().includes(term.toLowerCase())) {
                    folder.style.display = 'flex';
                } else {
                    folder.style.display = 'none';
                }
            });
            document.getElementById('path').innerHTML += `<span id="sterm"> | Filtered by ${term}</span>`;
        }
    
        document.getElementById('search').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const folders = document.querySelectorAll('.folder');
            folders.forEach(folder => {
                folder.style.display = 'flex';
            });
            document.getElementById('sterm').remove()
        });
    

        document.addEventListener('drop', (event) => {
    event.preventDefault();
    event.stopPropagation();

    for (const f of event.dataTransfer.files) {
        file = window.electron.webUtils.getPathForFile(f);
        console.log('workspace:', workspace || "NONE", 'file:', file);
        window.electron.addToWorkspace(workspace, file);
    }
});

document.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
});

document.addEventListener('dragenter', (event) => {
    console.log('File is in the Drop Space');
});

document.addEventListener('dragleave', (event) => {
    console.log('File has left the Drop Space');
});

window.electron.handleFileRemoved((file) => {
    document.querySelectorAll('.folder').forEach(f => {
        if (f.querySelector('.folder-name').innerHTML === file.name) {
            f.remove();
        }
    });
})

window.electron.handleFileColorChange((file) => {
    document.querySelectorAll('.folder').forEach(f => {
        if (f.querySelector('.folder-name').innerHTML === file.name) {
            f.querySelector('.folder-icon').style.color = file.color.toLowerCase();
        }
    });
})

window.electron.handleChangeSidebarColor((color) => {
    alert(color);

    // Set the sidebar background color
    sidebar.style.background = color;
    document.getElementById('location').style.background = color;

    // Calculate appropriate text color (light or dark)
    const textColor = getContrastColor(color);

    // Apply the text color to all elements inside the sidebar
    const sidebarElements = document.querySelectorAll('.sidebar *');
    sidebarElements.forEach(element => {
        element.style.color = textColor;
    });
    
})

window.electron.handleChangeSidebarWidth((width) => {
    document.querySelector('.sidebar').style.width = width;
    document.querySelector('.main-content').style.marginLeft = width;
})
    </script>
    
</body>
</html>